<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ma Collection de Mangas</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="style/bootstrap.min.css">
    <link rel="stylesheet" href="style/images.css">
    <link rel="icon" href="favicon.svg">
    <style>
        body {
            background-color: #121212;
            color: #ffffff;
        }
        .card {
            background-color: #1e1e1e;
            border: 1px solid #333;
        }
        .card-title {
            color: #ffffff;
        }
        .card-text {
            color: #cccccc;
        }
        .manga-card {
            transition: transform 0.3s;
        }
        .manga-card:hover {
            transform: scale(1.05);
        }
        .vertical-screen {
            width: 50%;
        }
        #carouselPrev,#carouselNext {
            filter: none;
        }
        #mangaGrid {
            opacity: 0;
            transition: opacity 0.2s ease-in;
        }
        .tag-container {
            padding: 0;
        }
        .tag-left {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }
        .tag-right {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row mb-4 sticky-top">
            <div class="col-md-8">
                <input type="text" id="searchInput" class="form-control" placeholder="Chercher un manga..." list="mangaTitles">
                <datalist id="mangaTitles">
                    <!-- Options will be populated by JS -->
                </datalist>
            </div>
            <div class="col-md-2">
                <button id="filterBtn" class="btn btn-primary w-100">Filtrer</button>
            </div>
            <div class="col-md-2">
                <button class="btn btn-secondary w-100" onclick="resetFilter()">Reset</button>
            </div>
        </div>

        <div id="mangaCarousel" class="carousel slide mb-4" data-bs-ride="carousel">
            <div class="carousel-inner">
                <!-- Carousel items will be populated by JS -->
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#mangaCarousel" data-bs-slide="prev">
                <span class="carousel-control-prev-icon" id="carouselPrev"></span>
                <span class="visually-hidden">Pr√©c√©dent</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#mangaCarousel" data-bs-slide="next">
                <span class="carousel-control-next-icon" id="carouselNext"></span>
                <span class="visually-hidden">Suivant</span>
            </button>
        </div>

        <div id="mangaGrid" class="row">
            <!-- Manga cards will be populated by JS -->
        </div>
    </div>

    <!-- Filter Modal -->
    <div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="filterModalLabel">Filtrer les Mangas</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="authorInput" class="form-label">Auteur</label>
                        <input type="text" class="form-control" id="authorInput" list="authorDatalist">
                        <datalist id="authorDatalist"></datalist>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Genres</label>
                        <div id="genresContainer"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Th√®mes</label>
                        <div id="themesContainer"></div>
                    </div>
                    <div class="mb-3">
                        <label for="editorInput" class="form-label">√âditeur</label>
                        <input type="text" class="form-control" id="editorInput" list="editorDatalist">
                        <datalist id="editorDatalist"></datalist>
                    </div>
                    <div class="mb-3">
                        <label for="statusSelect" class="form-label">Statut</label>
                        <select class="form-select" id="statusSelect"></select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Logique</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="logicRadio" id="orRadio" value="or" checked>
                            <label class="form-check-label" for="orRadio">
                                OR ( | )
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="logicRadio" id="andRadio" value="and">
                            <label class="form-check-label" for="andRadio">
                                AND ( & )
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="resetBtn">Reset</button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="applyFilterBtn">Filtrer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Manga Details Modal -->
    <div class="modal fade" id="mangaModal" tabindex="-1" aria-labelledby="mangaModalLabel">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="mangaModalLabel">D√©tails du Manga</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="mangaModalBody">
                    <!-- Content will be populated by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="style/bootstrap.bundle.min.js"></script>
    <script>
        let mangas = [];
        let currentMangas = [];
        let uniqueAuthors = new Set();
        let uniqueGenres = {};
        let uniqueThemes = {};
        let uniqueEditors = new Set();
        let uniqueStatuses = new Set([""]);
        let editors = {};
        
        async function loadMangas() {
            async function dParam(p) {
                const hBuffer = await window.crypto.subtle.digest("SHA-256",new TextEncoder().encode(p));
                return Array.from(new Uint8Array(hBuffer)).map(b=>b.toString(16).padStart(2,"0")).join("");
            }
            try {
                const response = await fetch('mangas.json');
                const data = await response.json();
                mangas = data.mangas;
                editors = data.editors;

                const pHash = await dParam(Array.from(new URLSearchParams(document.location.search).entries())[0]??"");
                if(pHash !== "da16976f3c6fe605679ab45bbe77180835fd17fd8538f7769a77e2e2fc8b0d29") {
                    mangas = mangas.filter(m => m.visible);
                }
                currentMangas = [...mangas];
                currentMangas.sort((a, b) => a.id.localeCompare(b.id));
                extractUniques();
                populateDatalist();
                populateModal();
                populateCarousel();
                populateGrid();
            } catch (error) {
                console.error('Error loading mangas:', error);
            }
        }

        function extractUniques() {
            mangas.forEach(manga => {
                manga.author.forEach(a => uniqueAuthors.add(a.split(' (')[0]));
                manga.genres.forEach(g => uniqueGenres[g] = (uniqueGenres[g] || 0) + 1);
                manga.themes.forEach(t => uniqueThemes[t] = (uniqueThemes[t] || 0) + 1);
                uniqueEditors.add(manga.editor);
                uniqueStatuses.add(manga.status);
            });
        }

        function populateDatalist() {
            const datalist = document.getElementById('mangaTitles');
            const sortedTitles = mangas.map(m => m.id).sort();
            sortedTitles.forEach(title => {
                const option = document.createElement('option');
                option.value = title;
                datalist.appendChild(option);
            });
        }

        function createBadge(l,r,m='') {
            return `<span class="text-nowrap btn align-baseline tag-container" ${m}><span class="badge bg-secondary bg-gradient tag-left">${l}</span><span class="badge bg-dark bg-gradient text-white-50 tag-right">${r}</span></span>`;
        }

        function populateModal() {
            // Authors datalist
            const authorDatalist = document.getElementById('authorDatalist');
            const sortedAuthors = Array.from(uniqueAuthors).sort((a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' }));
            sortedAuthors.forEach(author => {
                const option = document.createElement('option');
                option.value = author;
                authorDatalist.appendChild(option);
            });

            // Genres checkboxes in columns
            const genresContainer = document.getElementById('genresContainer');
            genresContainer.className = 'row';
            const sortedGenres = Object.keys(uniqueGenres).sort((a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' }));
            const numCols = 3;
            const itemsPerCol = Math.ceil(sortedGenres.length / numCols);
            for (let col = 0; col < numCols; col++) {
                const colDiv = document.createElement('div');
                colDiv.className = 'col';
                for (let i = col * itemsPerCol; i < Math.min((col + 1) * itemsPerCol, sortedGenres.length); i++) {
                    const genre = sortedGenres[i];
                    const div = document.createElement('div');
                    div.className = 'form-check';
                    div.innerHTML = `
                        <input class="form-check-input" type="checkbox" value="${genre}" id="genre${genre.replace(/\s+/g, '')}">
                        <label class="form-check-label" for="genre${genre.replace(/\s+/g, '')}">
                            ${createBadge(genre,uniqueGenres[genre])}
                        </label>
                    `;
                    colDiv.appendChild(div);
                }
                genresContainer.appendChild(colDiv);
            }

            // Themes checkboxes in columns
            const themesContainer = document.getElementById('themesContainer');
            themesContainer.className = 'row';
            const sortedThemes = Object.keys(uniqueThemes).sort();
            const itemsPerColThemes = Math.ceil(sortedThemes.length / numCols);
            for (let col = 0; col < numCols; col++) {
                const colDiv = document.createElement('div');
                colDiv.className = 'col';
                for (let i = col * itemsPerColThemes; i < Math.min((col + 1) * itemsPerColThemes, sortedThemes.length); i++) {
                    const theme = sortedThemes[i];
                    const div = document.createElement('div');
                    div.className = 'form-check';
                    div.innerHTML = `
                        <input class="form-check-input" type="checkbox" value="${theme}" id="theme${theme.replace(/\s+/g, '')}">
                        <label class="form-check-label" for="theme${theme.replace(/\s+/g, '')}">
                            ${createBadge(theme,uniqueThemes[theme])}
                        </label>
                    `;
                    colDiv.appendChild(div);
                }
                themesContainer.appendChild(colDiv);
            }

            // Editor datalist
            const editorDatalist = document.getElementById('editorDatalist');
            const sortedEditors = Object.keys(editors).sort((a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' }));
            sortedEditors.forEach(editor => {
                const option = document.createElement('option');
                option.value = editor;
                editorDatalist.appendChild(option);
            });

            // Status select
            const statusSelect = document.getElementById('statusSelect');
            const orderedStatuses = ["", "En cours", "Termin√©", "Termin√© en VO", "Abandonn√©"];
            orderedStatuses.forEach(status => {
                if (uniqueStatuses.has(status)) {
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = status;
                    statusSelect.appendChild(option);
                }
            });
        }

        function populateCarousel() {
            const carouselInner = document.querySelector('.carousel-inner');
            carouselInner.innerHTML = '';
            const shuffled = [...mangas].sort(() => Math.random() - 0.5);
            shuffled.forEach((manga, index) => {
                const item = document.createElement('div');
                item.className = `carousel-item ${index === 0 ? 'active' : ''}`;
                item.innerHTML = `
                    <div class="d-flex justify-content-center">
                        <div class="manga-card position-relative ${manga.thumbnail}" style="height: 300px; cursor: pointer;" onclick="showMangaDetails(this)" data-manga-id="${manga.id}">
                            <div class="position-absolute bottom-0 start-0 w-100 text-white p-2" style="background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);">
                                <h5 class="mb-0">${manga.title.main}</h5>
                            </div>
                        </div>
                    </div>
                `;
                carouselInner.appendChild(item);
            });
        }

        function populateGrid(titleFilter = '') {
            const grid = document.getElementById('mangaGrid');
            grid.style.transitionTimingFunction = 'ease-in';
            grid.style.opacity = 0;
            setTimeout(()=> {
                grid.innerHTML = '';
                const filteredMangas = currentMangas.filter(manga =>
                    manga.title.main.toLowerCase().includes(titleFilter.toLowerCase())
                );
                filteredMangas.forEach(manga => {
                    const col = document.createElement('div');
                    col.className = `col-12 col-sm-6 col-md-4 col-lg-3 mb-4${window.innerWidth<window.innerHeight ? " vertical-screen":""}`;
                    col.innerHTML = `
                        <div class="manga-card position-relative ${manga.thumbnail}" style="height: 300px; cursor: pointer;" onclick="showMangaDetails(this)" data-manga-id="${manga.id}">
                            <div class="position-absolute bottom-0 start-0 w-100 text-white p-2" style="background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);">
                                <h5 class="mb-0">${manga.title.main}</h5>
                            </div>
                        </div>
                    `;
                    grid.appendChild(col);
                });
                grid.style.transitionTimingFunction = 'ease-out';
                grid.style.opacity=1;
            },300);
        }

        document.getElementById('searchInput').addEventListener('input', () => {
            const filter = document.getElementById('searchInput').value;
            populateGrid(filter);
        });

        document.getElementById('filterBtn').addEventListener('click', () => {
            const modal = new bootstrap.Modal(document.getElementById('filterModal'));
            modal.show();
        });

        function resetFilter() {
            // Reset all inputs and checkboxes
            document.getElementById('authorInput').value = '';
            document.querySelectorAll('#genresContainer input').forEach(cb => cb.checked = false);
            document.querySelectorAll('#themesContainer input').forEach(cb => cb.checked = false);
            document.getElementById('editorInput').value = '';
            document.getElementById('statusSelect').querySelectorAll('option').forEach(o => o.selected = false);
            document.getElementById('orRadio').checked = true;
            document.getElementById('searchInput').placeholder = 'Chercher un manga...';
            currentMangas = [...mangas];
            currentMangas.sort((a, b) => a.id.localeCompare(b.id));
            populateGrid();
        }

        document.getElementById('resetBtn').addEventListener('click', () => {
            resetFilter();
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('filterModal'));
            modal.hide();
        });

        document.getElementById('applyFilterBtn').addEventListener('click', () => {
            const searchItems = [];
            let value;
            if(value = document.getElementById('authorInput').value) {
                searchItems.push({type: 'author', value: value});
            }
            for(const {value} of document.querySelectorAll('#genresContainer input:checked')) {
                searchItems.push({type: 'genre', value: value});
            }
            for(const {value} of document.querySelectorAll('#themesContainer input:checked')) {
                searchItems.push({type: 'theme', value: value});
            }
            if(value = document.getElementById('editorInput').value) {
                searchItems.push({type: 'editor', value: value});
            }
            if(value = document.getElementById('statusSelect').selectedOptions[0].value) {
                searchItems.push({type: 'status', value: value});
            }
            const filterMethod = document.querySelector('[name=logicRadio]:checked').value === 'or' ? 'some' : 'every';
            const filtered = mangas.filter(manga => searchItems[filterMethod](({type,value}) => {
                switch(type) {
                    case 'author': return manga.author.map(a => a.split(' (')[0]).includes(value);
                    case 'genre': return manga.genres.includes(value);
                    case 'theme': return manga.themes.includes(value);
                    case 'editor': const matchedKey = Object.keys(editors).find(key => key.includes(value));
                        if(matchedKey) {
                            return editors[matchedKey].includes(manga.editor);
                        } else {
                            return manga.editor === value;
                        }
                    case 'status': return manga.status === value;
                }
            }));
            currentMangas = searchItems.length > 0 ? filtered : mangas;
            currentMangas.sort((a,b) => a.id.localeCompare(b.id));
            populateGrid(document.getElementById('searchInput').value);
            document.getElementById('searchInput').placeholder = searchItems.length === 0 ? 'Chercher un manga...' : searchItems.map(({value})=>`"${value}"`).join(filterMethod==='some'?' OU ':' ET ');
            const modal = bootstrap.Modal.getInstance(document.getElementById('filterModal'));
            modal.hide();
        });

        loadMangas();

        function showMangaDetails(element) {
            function flagIcon(flag){
                return `<span class="flag-icon flag-icon-${flag}"></span>`;
            }
            function unbreakSpaces(text) {
                const replaces = [
                    [' ;','&nbsp;;'],
                    [' :','&nbsp;:'],
                    [' !','&nbsp;!'],
                    [' ?','&nbsp;?'],
                    [' ¬´ ','&nbsp;¬´&nbsp;'],
                    [' ¬ª','&nbsp;¬ª']
                ];
                for(const [a,b] of replaces) {
                    text = text.replaceAll(a,b);
                }
                return text;
            }
            let collectionColors = ["bg-secondary","bg-success","bg-warning"];
                let categoryBanners = {
                oneshot: ["info", "C'est un one-shot"],
                anthology: ["info", "C'est une anthologie"],
                extra: ["info", "C'est un hors-s√©rie"],
                hiatus: ["danger", "La s√©rie est en hiatus"],
                abandonned: ["danger", "La s√©rie est abandonn√©e"],
                english: ["warning", `${flagIcon("gb")} La s√©rie est en anglais`],
                japanese: ["warning", `${flagIcon("jp")} La s√©rie est en japonais`]
            };
            const id = element.dataset.mangaId;
            const manga = mangas.find(m => m.id === id);
            if (!manga) return;
            const modalBody = document.getElementById('mangaModalBody');
            let content = '<div class="row">';
            // Left side: thumbnail
            content += `<div class="col-md-4"><p class="${manga.thumbnail}"></p>`;
            content += `<p><strong>√âditeur:</strong> ${manga.editor}</p>`;
            content += `<p><strong>Volumes VO:</strong> ${manga.volumesVO}</p>`;
            content += `<p><strong>Volumes VF:</strong> ${manga.volumesVF}</p>`;
            content += `<p><strong>Statut:</strong> ${manga.status}</p>`;
            if(manga.nextRelease !== '') {
                content += `<p><strong>Prochaine sortie:</strong> ${new Date(manga.nextRelease).toLocaleDateString()}</p>`;
            }
            content += `<p><strong>Collection:</strong><div class="progress">`;
            for(let i=0; i<manga.tomes.length; i++) {
                content += `<div class="border progress-bar ${collectionColors[manga.tomes[i]]}" role="progressbar" style="width:${100/manga.volumesVO}%" data-bs-toggle="tooltip" data-bs-title="${i+1}"></div>`;
            }
            content += '</div></p>';
            if(manga.mediums.length > 0) {
                content += `<p><strong>Autres m√©dias:</strong> ${manga.mediums.join(', ')}</p>`;
            }
            content += `<p><strong><a href="${manga.link}" target="_blank">Lien</a></strong></p>`;
            content += '</div>';
            // Right side: info
            content += '<div class="col-md-8">';
            // Banner if specified category
            if(categoryBanners[manga.category]) {
                const [level,text] = categoryBanners[manga.category];
                content += `<div class="alert alert-${level}" role="alert">${text}</div>`;
            }
            // Titles
            content += '<h4>Titres:</h4><ul>';
            content += `<li>${flagIcon("fr")} ${manga.title.main}</li>`;
            if(manga.title.english) {
                content += `<li>${flagIcon("gb")} ${manga.title.english}</li>`;
            }
            if(manga.title.romaji || manga.title.kanji) {
                content += `<li>${flagIcon("jp")} ${[manga.title.romaji,manga.title.kanji].filter(t=>t).join(' / ')}</li>`;
            }
            if(manga.title.other) {
                content += `<li>Autre nom : ${manga.title.other}</li>`;
            }
            content += '</ul>';
            // Other info
            content += `<p><strong>Genres:</strong> ${manga.genres.map(g => createBadge(g,uniqueGenres[g],`onclick="simpleFilter('genre','${g}')"`)).join(' ')}</p>`;
            content += `<p><strong>Th√®mes:</strong> ${manga.themes.map(t => createBadge(t,uniqueThemes[t],`onclick="simpleFilter('theme','${t}')"`)).join(' ')}</p>`;
            content += `<p><strong>Auteur${manga.author.length>1?'s':''}:</strong> ${manga.author.join(', ')}</p>`;
            content += `<p><strong>Synopsis:</strong><br/>${unbreakSpaces(manga.synopsis)}</p><hr/>`;
            content += `<p><strong>Avis ‚òùü§ì:</strong> ${unbreakSpaces(manga.review)}</p>`;
            content += '</div></div>';
            modalBody.innerHTML = content;

            const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
            const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))

            const modal = new bootstrap.Modal(document.getElementById('mangaModal'));
            modal.show();
        }

        function closeMangaModal() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('mangaModal'));
            if (modal) modal.hide();
        }

        function simpleFilter(type,item) {
            closeMangaModal();
            resetFilter();
            document.getElementById(`${type}${item.replace(/\s+/g,'')}`).checked = true;
            document.getElementById('applyFilterBtn').click();
        }
    </script>
</body>
</html>